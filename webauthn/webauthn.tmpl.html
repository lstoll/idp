<html>

<head>
    <title>Webauthn</title>
    <link href="//cdn.muicss.com/mui-0.9.41/css/mui.min.css" rel="stylesheet" type="text/css" />
    <script src="//cdn.muicss.com/mui-0.9.41/js/mui.min.js"></script>
    <script src="/webauthn.js"></script>
    <style>
        .hide {
                display: none;
            }
        </style>
</head>

<body>
    <header class="mui-appbar mui--z1">
        <!-- Appbar HTML goes here -->
    </header>
    <div id="content-wrapper">
        <div class="mui--appbar-height"></div>
        <div class="mui-container-fluid">

            <!-- Default try and auth page -->
            <div id="logincard" class="mui-row">
                <div class="mui-col-md-4 mui-col-md-offset-4">
                    <div class="mui-panel mui--text-center">
                        <p>Login with your existing authenticator</p>
                        <p class="hide lead" id="loginLoading">Login started, please tap your authenticator.</p>
                        <form id="loginForm">
                            <input type="text" name="username" id="loginUsername" class="form-control" placeholder="Username"
                                value="{{ .Username }}" />
                            <button type="submit" class="btn btn-success mt-3">Login</button>
                        </form>
                        <p><a id="registerlink" href="#">Register key</a></p>
                    </div>
                </div>
            </div>

            <!-- Register form -->
            <div id="registercard" class="mui-row hide">
                <div class="mui-col-md-4 mui-col-md-offset-4">
                    <div class="mui-panel mui--text-center">
                        <p class="hide lead" id="registerLoading">Registering... Please tap your authenticator.</p>
                        <form id="registerForm">
                            <input type="text" name="username" id="registerLogin" class="form-control" placeholder="Username" />
                            <input type="password" name="password" id="registerPassword" class="form-control"
                                placeholder="Username" />
                            <button type="submit" class="btn btn-success mt-3">Register</button>
                        </form>
                    </div>
                </div>
            </div>

        </div>
    </div>
    <footer>
        <div class="mui-container mui--text-center">
        </div>
    </footer>

    <script type="text/javascript">
        let registerPending = false;
        let loginPending = false;

        let w = new WebAuthn();

        document.getElementById("registerForm").onsubmit = function (e) {
            e.preventDefault();
            if (registerPending) return;
            registerPending = true;
            document.getElementById("registerLoading").classList.remove("hide");
            w.register({ "username": document.getElementById('registerLogin').value, "password": document.getElementById('registerPassword').value })
                .then(res => {
                    registerPending = false;
                    document.getElementById("registerLoading").classList.add("hide");
                    // Trigger login process
                    document.getElementById("loginUsername").value = document.getElementById("registerLogin").value
                    document.getElementById("logincard").classList.add("hide");
                    document.getElementById("registercard").classList.remove("hide");
                    attemptAuthentication();
                })
                .catch(err => {
                    console.error(err)
                    alert('Failed to register: ' + err);
                })
                .then(() => {
                    registerPending = false;
                    document.getElementById("registerLoading").classList.add("hide");
                });
            // when registered successfully, attempt authentication
        };

        document.getElementById("registerlink").onclick = function (e) {
            document.getElementById("logincard").classList.add("hide");
            document.getElementById("registercard").classList.remove("hide");
        };

        function attemptAuthentication() {
            if (loginPending) return;
            loginPending = true;
            document.getElementById("loginLoading").classList.remove("hide");
            w.login({ "username": document.getElementById("loginUsername").value })
                .then(res => res.json())
                .then(res => window.location.href = res.redirect_to)
                .catch(err => {
                    console.error(err)
                    alert('Failed to login: ' + err);
                })
                .then(() => {
                    loginPending = false;
                    document.getElementById("loginLoading").classList.add("hide");
                });
        }

        document.getElementById("loginForm").onsubmit = function (e) {
            e.preventDefault();
            attemptAuthentication();
        }

        // If we have a preseeded username, auth immediately
        if (document.getElementById("loginUsername").value != "") {
           attemptAuthentication();
        }
    </script>
</body>

</html>